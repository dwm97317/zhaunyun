<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>中通云打印 MessageBuilder 保存测试</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 4px; }
        .test-section h3 { margin-top: 0; color: #333; }
        button { padding: 8px 15px; margin: 5px; cursor: pointer; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .field-btn { margin: 3px; padding: 5px 10px; background: #f0f0f0; border: 1px solid #ccc; border-radius: 3px; cursor: pointer; }
        .field-btn:hover { background: #e0e0e0; }
        .block-item { background: #fff; border: 1px solid #ddd; padding: 8px; margin: 5px 0; display: flex; align-items: center; }
        .block-item input { margin: 0 5px; }
        .block-container { min-height: 50px; background: #f9f9f9; padding: 10px; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <h1>中通云打印 MessageBuilder 保存测试</h1>
    
    <div class="test-section">
        <h3>测试 1: 模拟字段字典和积木构建</h3>
        <div id="test1-result"></div>
        <button onclick="test1()">运行测试 1</button>
    </div>
    
    <div class="test-section">
        <h3>测试 2: 模拟用户操作 - 添加字段</h3>
        <div style="margin-bottom: 10px;">
            <label><input type="checkbox" id="enableBuyerMessage"> 启用用户留言配置</label>
        </div>
        <div id="buyer-config" style="display:none; border: 1px solid #eee; padding: 10px;">
            <div class="field-list" id="buyer-field-list"></div>
            <div class="block-container" id="buyer-blocks"></div>
        </div>
        <div style="margin-top: 10px;">
            <button onclick="test2()">获取配置 JSON</button>
        </div>
        <div id="test2-result"></div>
    </div>
    
    <div class="test-section">
        <h3>测试 3: 模拟表单提交</h3>
        <form id="test-form">
            <input type="hidden" name="express[push_config_json]" id="push_config_json_input" value="">
            <div style="margin: 10px 0;">
                <label>渠道类型:</label>
                <label><input type="radio" name="express[ditch_type]" value="2" checked> 中通快递</label>
            </div>
            <button type="button" onclick="test3()">模拟提交</button>
        </form>
        <div id="test3-result"></div>
    </div>

    <script>
        // 字段字典
        var fieldDictionary = [
            {key: 'text', label: '自定义文本', type: 'text'},
            {key: 'order_sn', label: '订单号', type: 'field'},
            {key: 'create_time', label: '创建时间', type: 'field'},
            {key: 'buyer_remark', label: '用户留言', type: 'field'},
            {key: 'seller_remark', label: '后台备注', type: 'field'},
            {key: 'receiver.name', label: '收件人姓名', type: 'field'},
            {key: 'receiver.mobile', label: '收件人手机', type: 'field'}
        ];
        
        var buyerSchema = [];
        
        // 测试 1: 基础功能测试
        function test1() {
            var result = $('#test1-result');
            result.html('<p class="info">开始测试...</p>');
            
            try {
                // 测试字段字典
                result.append('<p class="success">✅ 字段字典加载成功，共 ' + fieldDictionary.length + ' 个字段</p>');
                
                // 测试积木构建
                var testSchema = [
                    {type: 'field', key: 'order_sn', prefix: '订单:', suffix: ''},
                    {type: 'text', value: ' - '},
                    {type: 'field', key: 'receiver.name', prefix: '', suffix: ''}
                ];
                
                result.append('<p class="success">✅ 测试 schema 构建成功</p>');
                result.append('<pre>' + JSON.stringify(testSchema, null, 2) + '</pre>');
                
                // 测试 JSON 序列化
                var jsonStr = JSON.stringify({
                    enableBuyerMessage: true,
                    ztoBuyerSchema: testSchema
                });
                result.append('<p class="success">✅ JSON 序列化成功</p>');
                result.append('<pre>' + jsonStr + '</pre>');
                
            } catch (e) {
                result.append('<p class="error">❌ 测试失败: ' + e.message + '</p>');
            }
        }
        
        // 渲染字段按钮
        function renderFieldButtons() {
            var html = '<p>点击添加字段:</p>';
            fieldDictionary.forEach(function(field) {
                html += '<button class="field-btn" onclick="addBlock(\'' + field.type + '\', \'' + field.key + '\', \'' + field.label + '\')">' + field.label + '</button>';
            });
            $('#buyer-field-list').html(html);
        }
        
        // 添加积木
        function addBlock(type, key, label) {
            var block = {type: type, key: key, label: label};
            if (type === 'text') {
                block.value = ' - ';
            } else {
                block.prefix = '';
                block.suffix = '';
            }
            buyerSchema.push(block);
            renderBlocks();
            console.log('添加积木:', block);
            console.log('当前 schema:', buyerSchema);
        }
        
        // 渲染积木
        function renderBlocks() {
            var html = '';
            buyerSchema.forEach(function(block, index) {
                var label = block.type === 'text' ? '文本' : (block.label || block.key);
                html += '<div class="block-item">';
                html += '<span style="background:#007bff; color:white; padding:3px 8px; border-radius:3px; margin-right:10px;">' + label + '</span>';
                
                if (block.type === 'text') {
                    html += '<input type="text" class="block-value" data-index="' + index + '" value="' + (block.value || '') + '" placeholder="文本内容" style="flex:1;">';
                } else {
                    html += '<input type="text" class="block-prefix" data-index="' + index + '" value="' + (block.prefix || '') + '" placeholder="前缀" style="width:100px;">';
                    html += '<span style="margin:0 5px;">' + block.key + '</span>';
                    html += '<input type="text" class="block-suffix" data-index="' + index + '" value="' + (block.suffix || '') + '" placeholder="后缀" style="width:100px;">';
                }
                
                html += '<button onclick="removeBlock(' + index + ')" style="margin-left:auto; background:#dc3545; color:white; border:none; padding:5px 10px; border-radius:3px; cursor:pointer;">删除</button>';
                html += '</div>';
            });
            $('#buyer-blocks').html(html);
            
            // 绑定输入事件
            $('.block-value, .block-prefix, .block-suffix').on('input', function() {
                var index = $(this).data('index');
                if ($(this).hasClass('block-value')) {
                    buyerSchema[index].value = $(this).val();
                } else if ($(this).hasClass('block-prefix')) {
                    buyerSchema[index].prefix = $(this).val();
                } else if ($(this).hasClass('block-suffix')) {
                    buyerSchema[index].suffix = $(this).val();
                }
                console.log('更新 schema:', buyerSchema);
            });
        }
        
        // 删除积木
        function removeBlock(index) {
            buyerSchema.splice(index, 1);
            renderBlocks();
            console.log('删除后 schema:', buyerSchema);
        }
        
        // 测试 2: 获取配置
        function test2() {
            var result = $('#test2-result');
            result.html('<p class="info">获取配置...</p>');
            
            try {
                var config = {
                    enableBuyerMessage: $('#enableBuyerMessage').is(':checked'),
                    ztoBuyerSchema: buyerSchema
                };
                
                var jsonStr = JSON.stringify(config);
                
                result.append('<p class="success">✅ 配置获取成功</p>');
                result.append('<p>启用状态: ' + config.enableBuyerMessage + '</p>');
                result.append('<p>积木数量: ' + buyerSchema.length + '</p>');
                result.append('<pre>' + jsonStr + '</pre>');
                
                // 检查 JSON 长度
                result.append('<p class="info">JSON 字符串长度: ' + jsonStr.length + ' 字符</p>');
                
            } catch (e) {
                result.append('<p class="error">❌ 获取配置失败: ' + e.message + '</p>');
            }
        }
        
        // 测试 3: 模拟提交
        function test3() {
            var result = $('#test3-result');
            result.html('<p class="info">模拟提交...</p>');
            
            try {
                // 构建完整配置
                var config = {
                    ztoPrinterConfig: {
                        printerId: 'test-printer',
                        deviceId: 'test-device',
                        printChannel: 'ZOP',
                        paramType: 'DEFAULT_PRINT'
                    },
                    enableBuyerMessage: $('#enableBuyerMessage').is(':checked'),
                    ztoBuyerSchema: buyerSchema,
                    enableSellerMessage: false,
                    ztoSellerSchema: []
                };
                
                var jsonStr = JSON.stringify(config);
                $('#push_config_json_input').val(jsonStr);
                
                result.append('<p class="success">✅ 隐藏字段已更新</p>');
                result.append('<p>字段值长度: ' + jsonStr.length + ' 字符</p>');
                result.append('<pre>' + jsonStr + '</pre>');
                
                // 模拟表单数据
                var formData = $('#test-form').serializeArray();
                result.append('<p class="success">✅ 表单数据:</p>');
                result.append('<pre>' + JSON.stringify(formData, null, 2) + '</pre>');
                
                // 检查 HTML 实体编码
                var rawValue = $('#push_config_json_input').val();
                if (rawValue.indexOf('&quot;') !== -1 || rawValue.indexOf('&amp;') !== -1) {
                    result.append('<p class="error">⚠️ 警告: 检测到 HTML 实体编码，可能需要解码</p>');
                } else {
                    result.append('<p class="success">✅ 无 HTML 实体编码问题</p>');
                }
                
            } catch (e) {
                result.append('<p class="error">❌ 模拟提交失败: ' + e.message + '</p>');
            }
        }
        
        // 初始化
        $(function() {
            console.log('页面加载完成');
            
            // 监听复选框
            $('#enableBuyerMessage').on('change', function() {
                var enabled = $(this).is(':checked');
                $('#buyer-config').toggle(enabled);
                if (enabled) {
                    renderFieldButtons();
                }
            });
        });
    </script>
</body>
</html>
