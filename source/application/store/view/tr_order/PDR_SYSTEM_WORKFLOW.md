# PDR 系统设计流程与任务管理

## 📚 文档体系

本项目采用 **PDR (Project Design Review)** 驱动开发模式，确保每个功能都经过完整的设计、审阅、实现、验证流程。

---

## 🔄 PDR 标准流程

### 阶段 1️⃣：需求分析与设计
```
用户需求 → AI 分析 → 编写 PDR 文档 → 用户审阅
```

**输出物**：
- `PDR_[功能名称].md` - 完整的设计文档
- 包含：需求背景、技术方案、实现步骤、测试用例、风险评估

**审阅要点**：
- [ ] 需求理解是否准确
- [ ] 技术方案是否可行
- [ ] 是否考虑了边界情况
- [ ] 是否有遗漏的场景

---

### 阶段 2️⃣：任务拆解与规划
```
PDR 审阅通过 → 生成任务清单 → 确定优先级 → 分配开发顺序
```

**输出物**：
- `TASK_[功能名称].md` - 任务清单文档
- 包含：任务列表、依赖关系、验收标准、时间估算

---

### 阶段 3️⃣：开发实现
```
按任务清单逐项开发 → TDD 验证 → 代码审查 → 提交
```

**开发原则**：
- 遵循 PDR 设计方案
- 使用 TDD 工具验证每个步骤
- 不假设任何接口/字段存在（源码优先原则）
- 保持业务模型完整性

---

### 阶段 4️⃣：测试验证
```
单元测试 → 集成测试 → 用户验收测试 → 生产验证
```

**验证方式**：
- TDD 脚本验证数据库操作
- 浏览器测试验证前端交互
- 真实业务场景测试

---

### 阶段 5️⃣：文档归档与总结
```
更新文档 → 记录问题 → 总结经验 → 存入记忆
```

**归档内容**：
- 最终 PDR 版本
- 测试报告
- 遇到的问题及解决方案
- 经验教训

---

## 📋 当前项目 PDR 文档清单

### 已完成的 PDR

| 文档名称 | 功能描述 | 状态 | 创建日期 |
|---------|---------|------|----------|
| `PDR_SF_Multi_Box.md` | 顺丰多箱子母单功能（后端） | ✅ 已实现 | 2026-01-29 |
| `PDR_Display_Child_Waybills.md` | 前端显示子单号功能 | 📝 待审阅 | 2026-01-30 |

### 已废弃的 PDR

| 文档名称 | 废弃原因 | 日期 |
|---------|---------|------|
| `PDR_SF_Split_Order.md` | 需求理解错误（非拆单，是多箱） | 2026-01-29 |

---

## 📊 当前任务状态

### 🎯 进行中的任务

#### 任务 1：前端显示子单号功能
**PDR 文档**: `PDR_Display_Child_Waybills.md`  
**当前阶段**: 📝 PDR 审阅中  
**下一步**: 生成任务清单 → 开发实现

**关键决策点**：
- [x] 显示方案选择：方案 A（直接展开显示）
- [ ] PDR 审阅通过
- [ ] 任务拆解完成
- [ ] 开发实现
- [ ] 测试验证

---

## 🔍 PDR 审阅检查清单

### 对于 `PDR_Display_Child_Waybills.md`

#### ✅ 需求理解
- [x] 明确了业务场景（多箱订单显示）
- [x] 明确了显示位置（订单列表页）
- [x] 明确了显示方式（方案 A - 直接展开）

#### ✅ 技术方案
- [x] 数据来源清晰（`yoshop_inpack_item.t_order_sn`）
- [x] 数据查询方式明确（需加载 `packageitems` 关联）
- [x] 前端实现逻辑完整（提供了完整代码）
- [x] 样式设计合理（缩进、Badge 标识）

#### ✅ 实现步骤
- [x] 后端准备步骤明确
- [x] 前端开发步骤清晰
- [x] 测试场景完整

#### ✅ 风险评估
- [x] 识别了技术风险（关联数据未加载）
- [x] 识别了业务风险（箱子过多）
- [x] 提供了应对措施

#### 🔍 待确认事项
- [ ] **后端关联数据加载**：需验证 `TrOrder::index()` 是否已加载 `packageitems`
- [ ] **旧数据兼容性**：确认旧订单是否有 `packageitems` 数据
- [ ] **物流查询功能**：确认 `getlog(this)` 是否支持子单号查询

#### 💡 优化建议
- [ ] 考虑增加"箱子编号"显示（如"箱 #1"、"箱 #2"）
- [ ] 考虑增加重量显示（如"1.5kg"）
- [ ] 考虑增加物流状态标识（已签收/运输中）

---

## 📝 下一步：生成任务清单

如果 PDR 审阅通过，将生成 `TASK_Display_Child_Waybills.md`，包含：

### 任务拆解示例

```
Task 1: 后端验证与准备
├─ 1.1 验证 TrOrder::index() 是否加载 packageitems
├─ 1.2 如未加载，修改控制器添加关联查询
└─ 1.3 TDD 验证数据结构正确

Task 2: 前端实现
├─ 2.1 修改 index.php Line 414-418
├─ 2.2 添加多箱判断逻辑
├─ 2.3 添加子单号循环显示
└─ 2.4 添加样式（缩进、Badge）

Task 3: 功能测试
├─ 3.1 单箱订单显示测试
├─ 3.2 多箱订单（顺丰）显示测试
├─ 3.3 多箱订单（中通）显示测试
├─ 3.4 复制功能测试
└─ 3.5 物流查询功能测试

Task 4: 兼容性测试
├─ 4.1 旧数据兼容性测试
├─ 4.2 空数据处理测试
└─ 4.3 浏览器兼容性测试
```

---

## 🎯 项目整体进度

### 已完成功能
- ✅ 顺丰子母单后端逻辑（`TrOrder::sendtoqudaoshang`）
- ✅ 中通多箱独立单后端逻辑
- ✅ 数据库表结构（`yoshop_inpack_item.t_order_sn`）
- ✅ TDD 测试脚本（`test_sf_multibox.php`）

### 进行中功能
- 📝 前端显示子单号（PDR 审阅中）

### 待开发功能
- ⏳ 订单详情页显示箱子运单号
- ⏳ 批量复制运单号功能
- ⏳ 子单物流轨迹查询
- ⏳ 运单号修改/取消功能

---

## 📖 PDR 模板

为保持文档一致性，所有 PDR 应包含以下章节：

```markdown
# PDR: [功能名称]

## 一、需求背景
### 1.1 业务场景
### 1.2 当前问题
### 1.3 用户需求

## 二、解决方案
### 2.1 方案选择
### 2.2 选择理由

## 三、技术设计
### 3.1 数据流
### 3.2 实现逻辑
### 3.3 样式设计（如适用）

## 四、实现步骤
### 4.1 后端开发
### 4.2 前端开发
### 4.3 测试验证

## 五、测试用例
### 5.1 测试场景
### 5.2 验证点

## 六、后续优化（可选）

## 七、风险评估

## 八、相关文档

## 九、变更记录

## 十、附录
```

---

## 🔧 工具与规范

### TDD 工具使用
- 所有数据库操作必须使用 MCP MySQL 工具验证
- 所有代码修改前必须先验证源码存在性
- 测试脚本统一放在 `web/` 目录，命名格式：`test_[功能]_[场景].php`

### 代码规范
- 遵循项目现有代码风格
- 不修改业务数据结构假设
- 保持业务模型完整性
- 优先使用源码中已有的方法和模式

### 文档规范
- PDR 文档放在功能相关的目录下
- 使用 Markdown 格式
- 包含完整的代码示例
- 提供清晰的数据流图

---

## 📞 审阅反馈

请审阅 `PDR_Display_Child_Waybills.md`，并提供以下反馈：

1. **需求理解**：是否准确理解了您的需求？
2. **技术方案**：方案 A 是否符合您的预期？
3. **实现细节**：代码示例是否清晰？是否有遗漏？
4. **待确认事项**：上述"待确认事项"中哪些需要优先验证？
5. **优化建议**：是否需要立即实现某些优化功能？

---

**审阅完成后，我将生成详细的任务清单并开始实现。**
