# Release Note - Commit 155c61b5

本次提交 `155c61b5` 是一个包含大量功能增强和架构优化的综合性提交，主要涉及 **物流轨迹回调系统的统一重构**、**订单管理功能的增强** 以及 **代码库的清理**。

## 1. 核心重构：物流轨迹回调系统 (`Trace Services`)
引入了全新的 `Service` 层结构来标准化处理不同物流商的回调数据，解决了之前逻辑分散的问题。

*   **新增服务类** (`source/application/common/service/trace/`):
    *   `SfService.php` (顺丰): 统一处理顺丰的路由推送。支持新版 (`orderState`) 和旧版 (`WaybillRoute`) 两种格式，自动识别并更新主单 (`Inpack`) 或子单 (`InpackItem`) 的状态。
    *   `JdService.php` (京东) & `ZtoService.php` (中通): 同样封装了各自的解析逻辑。
*   **统一回调入口** (`source/application/api/controller/Callback.php`):
    *   重写了回调控制器，将业务逻辑剥离到上述 Service 中。
    *   增加了 **容错处理**：同时兼容 `php://input` (JSON) 和 `$_POST` (Form Data) 两种接收方式，解决了部分物流商回调格式不稳定的问题。
    *   增加了 **详细日志**：每个接口都会记录原始请求到 `runtime/log/xx_dump.log`，便于排查问题。

## 2. 订单管理功能增强 (`TrOrder.php`)
在后台订单管理控制器中增加了多个实用功能：

*   **订单复制 (`copyOrder`)**:
    *   实现了订单的“一键复制”功能。
    *   **智能重置**：复制时会自动生成新订单号，保留收件人、商品等核心信息，但自动清除支付状态、物流单号、时间戳等“状态”数据，并将订单重置为“待查验”。
*   **批量支付状态修改 (`batchPayStatus`)**:
    *   允许管理员批量修改订单的支付状态（未支付/已支付）和支付方式。
*   **物流下单对接 (`sendtoqudaoshang`)**:
    *   扩展了发货逻辑，新增了对 **ZTO (中通)** 和其他渠道（Type 2/3）的支持。
    *   完善了发件人信息构建逻辑，自动从仓库配置 (`ShopModel`) 获取发件人地址，确保电子面单信息准确。

## 3. 系统配置与清理
*   **`.gitignore` 更新**:
    *   新增了大量忽略规则，排除了本地测试脚本 (`test_*.php`, `test_*.ps1`)、文档 (`*.md`, `*.docx`) 和临时文件。
    *   确保线上代码库保持干净，不包含本地调试产生的垃圾文件。

## 总结
这是一个 **里程碑式的提交**，它不仅通过引入 Service 层提高了代码的可维护性，还完善了实际业务中急需的“订单复制”和“多物流商自动对接到货/签收通知”的功能。

---
**附：提交统计**
*   **包含文件**: 93 个文件被修复/新增
*   **主要变更**: 3339 行代码插入 (主要集中在 Service 新增和 Controller 扩展)
